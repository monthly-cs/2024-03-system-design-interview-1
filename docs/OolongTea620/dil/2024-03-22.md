### 일관성 불일치 해소(inconsistency resolution)
... 장애 감지 불일치에 이어서

### 장애 해소 전략들(failure resolution)

**느슨한 정족수 접근법**

#### **후임시위탁기법** : 일시적 장애 처리
- 네트워크, 서버 문제로 장애 상태인 서버로 가는 요청은 다른 서버가 잠시 맡아서 처리하는 것
- 그 상황에서 발생하는 변경사항은 해당 서버가 복구될 때 일관 반영하여 데이터 일관성 보존
- 임시 서버에 그에 대한 단서(hint)를 남겨둔다.

#### **반-엔트로피 프롵토콜 구현** : 영구적인 노드의 장애 상태 처리 방법

- 사본들을 비교하여 최신 버전의 데이터로 갱신하는 과정이다.
- `머클트리(merkle)`: 사본간의 일간성이 망가진 상태를 탐지하고 전송 데이터의 양을 줄이기 위한 방식

#### 머클트리?

- 각 노드에 자식 노드들에 보관된 값의 해시(자식 노드가 종단인 경우)
- 자식 노드들의 레이블로부터 계산된 해시값을 레이블로 붙여두는 트리
- 대규모 자료구조의 내용을 효과적이면서도 보안상으로 안전한 방법으로 검증(verification)할 수 있다.  


#### 데이터 센터 장애 처리

정전, 네트워크, 장애, 자연재해 등 다양한 이유로 발생할 수 있다.

데이터센터 장애에 대응하기 위한 시스템을 만들기 위해서는 **데이터를 여러 데이터 센터의 다중화**하는 것이 중요하다.

---
여기까지는 키-값 저장소를 만드는데 필요한 다양한 기술들

### 시스템 아키텍처 다이어그램

- 클라이언트는 키-값 저장소가 제공하는 두 가지 단순한 API 즉, get(key) 및 put(key, value)와 통신한다

- 중재자(coordination)은 클라이언트에게 키-값 저장소에 대한 프록시(proxy)역할을 하는 노드이다.
- 노드는 안정 해시의 해시 링 위에 분포한다.
- 노드를 자동으로 추가 / 삭제할 수 있도록 시스템은 완전히 분산한다.
- 데이터는 여려 노드에 다중화한다.
- 모든 노드가 같은 책임을 진다. SPOF(Single Point Of Failure)는 존재하지 않는다.

## 노드에 쓰기, 읽기가 요청 될 때

### 쓰기 경로(write path)

쓰기 요청이 특정 노드에 전달 된다면?
```
1. 쓰기 요청이 커밋 로그(commit log)파일에 기록된다.
2. 데이터가 메모리 캐시에 기록된다.
3. 메모리 캐시가 가득차거나, 사전에 정의한 어떤 임계치에 도달하면 데이터는 디스크에 있는 SSTable에 기록된다.  
```

### 읽기 경로(read path)

- 읽기 요청 발생 시, 노드는 데이터가 메모리 캐시에 있는지부터 확인한다.
- 메모리 캐시에 데이터가 있는 경우, 해당 데이터를 메모리에서 가져와서 클라이언트에게 반환한다.

- **메모리에 없는 경우**, 디스크에서 가져온다.
  - key가 존재하는 SSTable을 찾기 위해서 `블룸 필터`가 흔히 사용된다.

```
1. 데이터가 메모리에 있는지 검사한다 없으면 2번 부터 시작이다.
2. 데이터가 메모리에 없으므로, 블룸 필터를 검사한다.
3. 블룸 필터를 통해서 어떤 SSTable에 키가 보관되어 있는지 알아낸다.
4. SSTable에서 데이터를 가져온다.
5. 해당 데이터를 클라이언트에게 반환한다.
```

## 정리

|목표/문제|기술|
|:----|:----|
|대규모 데이터 저장|안정 해시를 사용해 서버들에 부하 분산|
|읽기 연산에 대한 높은 가용성 보장|데이터를 여러 데이터 센터에 다중화|
|쓰기 연산에 대한 높은 가용성 보장|버저닝 및 벡터 시계를 사용한 충돌 해소|
|데이터 파티션|안정 해시|
|점진적 규모 확장성|안정 해시|
|다양성|안정 해시|
|조절 가능한 데이터 일관성|정족수 합의|
|일시적 장애 처리|느슨한 정족수 프로토콜, 단서 후 임시 위탁|
|영구적 장애 처리|머클 트리|
|데이터 센터 장애 대응|여러 데이터 센터에 걸친 데이터 다중화|


## 총평
> 1. 나의 포인트는 장애 처리 관련 조사
> 2. 데이터 일관성을 위해서 코드레벨에서 할 수있는 방법은?
