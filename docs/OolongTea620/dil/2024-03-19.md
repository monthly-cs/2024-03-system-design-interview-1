# 키-값 저장소 설계

#### 설명

Key-Value `비 관계형 데이터베이스`를 가리킨다.   
키-값은 `고유 식별자(identifier)`를 키로 가져야한다.
- 키는 유일하다.
- ` 값은 키를 통해서만 접근가능하다.
- "키-값" 쌍 관계(pair) : 키와 값 사이의 연결관계
- 키는 짧을 수록 좋다.

#### 대표적인 데이터베이스

```
Amazon DynamoDB, memcachedm redis...
```

## 책에서는 무엇을 해결하고 싶은데?

👉이런 특성을 가지는 키-값 저장소를 설계하고 싶어

```
- 키-값 쌍의 크기는 10K이하 (왜?)
- 큰 데이터를 저장할 수 있어야 한다. (얼마나?)
- 높은 가용성을 제공해야하 한다, (서버가 장애가 생기더라도 빨리 응답할 수 있어야 한다)
- 높은 규모 확장성을 제공해야한다(트래픽 양에 따라서 서버 증설/삭제가 이루어져야 한다)
- 데이터 일정 수준은 조정이 가능해야한다.
- 응답 지연시간(latency)이 짧아야 한다(얼마나?)
```
### 단일 키-값 저장소

단일 저장소에 한정 짓지 않고 키-값 데이터를 이용하는 방법

- 데이터 압축
- 자주 쓰이는 데이터는 메모리에 두고, 나머지는 디스크에 저장
        
```markdown
👉 많은 데이터를 저장하기 위해서 **분산 키-값** 저장소가 필요
```

### 분산 키-값 저장소

분산 키-값 저장소는 분산 해시 테이블이라고 불린다.   
키-값쌍 데이터를 여러 서버에 분산 저장한다.

#### CAP 정리


데이터 일관성(consistency), 가용성(availability), 파티션 감내(partion tolerance) **세가지 요구 사항을 만족하는 분산 시스템을 설계하는 것은 불가능하다**

- 데이터 일관성(C) : 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.

- 가용성(A) : 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생 하더라도 항상 응답을 받을 수 있어야 한다.

- 파티션 감내(P) : 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여 한다는 것을 의미한다.

```
두가지를 선택하면 반드시 하나는 포기하는 상황이 온다.
```

#### CAP에 따른 저장소 유형 분류

|이름 |설명|
|:------------: |:---------|
| CP 시스템| 일관성과 파티션 감내를 지원하는 키-값 저장소|
| AP 시스템| 가용성과 파티션 감내를 지원하는 키-값 저장소|
| CA 시스템| 일관성과 가용성을 지원하는 키-값 저장소<br>**하지만, 분산 시스템은 반드시 파티션 문제를 감당할 수 있도록 설계되어야 하므로, CA시스템은 존재하지 않는다**| 

### 사례1. 세 대의 복제 노드 n1,n2,n3

#### 이상적 상태 
네트워크가 파티션되는 상황은 절대로 일어나지 않음   
n1에 기록된 데이터는 n2, n3에 복제된다(데이터 일관성, 데이터 가용성 만족)


#### 실세계 분산 시스템
n3에 문제 발생
- n1,n2에 기록된 데이터는 n3에 전달되지 않는다.
- n3에 기록되었으나, n1,n2로 전달되지 못한 데이터가 있을 수 있다.

CP시스템(일관성)선택 시
- 세 서버 사이에 생길 수 있는 데이터 불일치 문제를 해소하기 위해서 n1,n2 서버의 쓰기 연산 중단
- 가용성을 결론적으로 포기하게 된다.

```
은행시스템의 경우, 비즈니스 특성상, 일관성을 절대로 놓쳐서는 안된다.
따라서 상황이 해결될 때 까지는 오류를 반환한는 방법을 택한다.
```

AP(가용성)선택 시
- 낡은 데이터를 반환할 위험이 있더라도, 쓰기 연산을 허용해야한다.
- n1,n2는 쓰기연산을 허용할 것, 파티션 문제가 일어난 뒤, 새 데이터를 n3에 전송할 것

#### 결론

시스템 성격에 맞게 분산 시스템 방식을 선택할 수 있어야 한다.


## 시스템 컴포넌트

키-값 저장소 구현에 사용되는 핵심 컴포넌트 및 기술

- 데이터 파티션
- 데이터 다중화(replication)
- 일관성(consistency)
- 일관성 불일치 해소(inconsistency resolution)
- 장애 처리
- 시스템 아키텍처 다이어그램
- 쓰기 경로(write path)
- 읽기 경로(read path)

### 데이터 파티션
대규모 어플리케이션의 경우, 데이터를 작은 파티션들로 분할하고, 여러 대 서버에 저장한다.

#### 데이터 파티션을 나눌 때 고려할 상황

- 데이터를 여러 서버에 고르게 분산할 수 있을까?
- 노드가 추가되거나, 삭제될 때, 데이터의 이동을 최소화 할 수 있을까?

#### 안정 해시(consistent hash)도입 장점

**장점**
- 규모 확장 자동화(automatic scaling): 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들 수 있다.

- 다양성(heterogeneity): 각 서버의 용량에 맞게 가상 노드(virtual node)의 수를 조정할 수 있다. 고성능 서버는 더 많은 가상 노드를 갖도록 설정 할 수 있다.


### 데이터 다중화(replication)

높은 가용성과 안정성을 확보하기 위해서 데이터를 N개 서버에 **비동기적으로 다중화**할 필요가 있다.

N: 튜닝 가능한 값

- 어떤 키를 해시 링 위에 배치한 후, 그 지점으로 부터 시계방향으로 링을 순회하면서 첫 N개 서버에 데이터 사본을 보관한다.

가상 노드 사용 시, N개의 노드가 대응될 실제 물리 서버의 개수가 N보다 작아질 수 있다. 

- 노드를 선택할 때, 값은 물리 서버를 중복선택하지 말아야 한다.

#### 같은 데이터 센터

같은 데이터센터에 속한 노든는 정전, 네트워크, 자연재해등을 동시에 겪을 가능성이 있다.

안정성을 담보하기 위해서 데이터의 사본은 다른 센터의 서버에 보관되고 센터들은 고속 네트워크로 연결한다.
