# 8장 URL 단축키 설계

```
👉 시스템 설계 면접 문제는 정해진 결말이 없도록 만들어진다.
```

## 1단계 - 문제 이해 및 설계 범위 확정

**책에서의 가정한 요구 사항**
```
- 단축 URL을 결과로 제공, 해당 단축 URL 접속하면 원래 URL로 이동을 갈 수도 있어야 한다.
- 트래픽의 규모 : 매일 1억개의 단축 URL을 만들어 낼 줄 알아야 한다.
- 단축 URL의 길이는 짧을수록 좋음.
- 단축 URL의에는 숫자(0-9), 영문자(a-z,A-Z)만 사용할 수 있음
- 단축 URL은 삭제나 갱신 불가능 하다고 가정 
```

**시스템의 기본적 기능**
```
1. URL 단축 :: 주어진 긴 URL을 훨씬 짧게 줄인다.
2. URL 리디엑션 : 축약된 URL로 HTTP 요청이 들어오면 원래 URL로 안내
3. 높은 가용성, 규모 확장성, 그리고 장애 감내가 요구됨
```

**개략적인 추정**
```
- 쓰기 연산 : 매일 1억개의 단축 URL 생성
- 초당 쓰기 연산 : 1억(100 milion) / 24 / 3600 / 1160
- 읽기 연산 : 읽기 연산과 쓰기 연산 비율은 10 : 1 이라고 하자, 해당 경우 읽기 연산은 11,600/1초 발생한다
- URL 단축 서비스를 10년간 운영한다고 가정하면, 1억 X 365 X 10 = 3650억개의 레코드 보관 필요
- 축약 전, URL의 평균 길이는 100이라고 하자
- 따라서, 10년 동안 필요한 저장 용량은 3650억 X 100 바이트 = 36.5 TB 이다. 
```

## 2단계 - 개략적인 설계안 제시 및 동의 구하기

**Focus On...**

```
- API 엔드포인트
- URL 리디렉션
- URL 단축 플로우
```

### API EndPoint

- `Client`는 서버가 제공하는 API엔드포인트를 통해 서버돠 통신한다.
- API엔드포인트를 REST스타일로 설계.
- URL 단축키는 기본적으로 2개의 엔드포인트를 필요로 한다.

```
1. URL 단축용 엔드포인트 : 새 단축 URL을 생성하고하 하는 클라이언트는 이 엔드포인트에 단축할 URL을 인자로 실어서 POST 요청을 보내야 한다.

POST/api/v1/data/shorten
* 인자 : (longUrl : longURLstring)
* 반환 : 단축 URL

- URL 리디렉션용 엔드포인트 : 단축 URL에 대해서 HTTP 요청이 오면 원래 URL로 보내주기 위한, 용도의 엔드포인트 다음과 같은 형태를 띤다.

- GET /api/v1/shorUrl
* 반환 : HTTP 리디렉션 목적지가 될 원래 URL
```

### URL 리디렉션

클라이언트 - 서버 사이의 통신 절차

**유의점**  
301응답과 302 응답의 차이

- **301 permanently Moved** : 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location헤더에 반환된 URL로 이전되었다는 응답.
  - 영구적 이전 - 브라우저는 이 응답을 캐시(cache)한다.
  - 추후 같은 단축 URL에 요청을 보낼 필요가 있을 때, 브라우저는 캐시된 원래 URL로 요청을 보내게 된다.
  - 서버 부하 줄어듦
- **302 Found** : 주어진 URL의 요청이 일시적으로 Location 헤더가 지칭하는 URL에 의해 처리되어야 한다는 응답이다.
  - 클라이언트의 요청은 언제나 단축 URL 서버에 먼저 보내진 후, 원래 URL로 리디렉션 되어야 한다.
  - 트래픽 분석(analytics)이 중요할 때 사용(클릭 발생률, 발생 위치를 추적하는게 좀 더 유리)

**구현의 직관적 방법? :**  `해시 테이블` 사용

```
- 원래 URL = hashTable.get(단축 URL)
- 301또는 302응답 Location 헤더에 원래 URL을 넣은 후 전송
```

### URL 단축

긴 URL을 이 해시 값으로 대응시킬 해시 함수 fx를 찾는 일이 될 것이다.

**만족해야하는 요구사항**
```
- 입력으로 주어지는 긴URL이 다른 값이면 해시 값도 달라야
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원 될 수 있어야 한다.
```

\> **3단계에서 추가 설명**