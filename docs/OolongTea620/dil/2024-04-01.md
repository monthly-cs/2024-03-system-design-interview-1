# 번외 :  ID 성성기 예제 코드 보기

## 1. JPA 서적에서 나온 ID DB 자동 생성 API 전략


### JPA에서 제공하는 데이터베이스 기본 키 생성 전략

`직접 할당` : 기본 키를 어플리케이션에서 직접 할당
`자동 생성` : 대리키 사용 방식

#### 자동 생성 방식 
```
- IDENTITY : 기본키 생성을 데이터베이스에 위임한다.
- SEQUENCE : 데이터베이스 시퀀스를 사용하여 기본 키를 할당한다.
- TABLE : 키 생성 테이블을 사용한다.
```

#### 기본 키 직접 할당 방식

**ID로 사용가능한 Java 타입**

```
- 자바 기본형(primitive type)
- 자바 래퍼(Wrapper)형
- String
- java.util.Date
- java.sql.Date
- java.math.BigDecimal
- java.math.bigInteger
```

> em.persist()로 엔티티를 저장하기 전에 애플리케이션에서 기본 키를 직접 할당하는 방법이다.

어떻게 진행을 해야할까????

## 그래서 Custom Generator 하게 ID을 생성하려면..?

> *we can define our custom generator by **implementing the IdentifierGenerator interface***

[출처 : www.baeldung.com](https://www.baeldung.com/hibernate-identifiers)

### 한번 코드를 보자

```java
public class MyGenerator 
  implements IdentifierGenerator, Configurable {

    private String prefix;

    @Override
    public Serializable generate(
      SharedSessionContractImplementor session, Object obj) 
      throws HibernateException {

        String query = String.format("select %s from %s", 
            session.getEntityPersister(obj.getClass().getName(), obj)
              .getIdentifierPropertyName(),
            obj.getClass().getSimpleName());

        Stream ids = session.createQuery(query).stream();

        Long max = ids.map(o -> o.replace(prefix + "-", ""))
          .mapToLong(Long::parseLong)
          .max()
          .orElse(0L);

        return prefix + "-" + (max + 1);
    }

    @Override
    public void configure(Type type, Properties properties, 
      ServiceRegistry serviceRegistry) throws MappingException {
        prefix = properties.getProperty("prefix");
    }
}
```
**엔티티 적용 부분**

```java
@Entity
public class Product {

    @Id
    @GeneratedValue(generator = "prod-generator")
    @GenericGenerator(name = "prod-generator", 
      parameters = @Parameter(name = "prefix", value = "prod"), 
      strategy = "com.baeldung.hibernate.pojo.generator.MyGenerator")
    private String prodId;

    // ...
}
```


### 결론 : Sequence나 table형도 괜찮지 않을까?


### 다음 호기심 : 키를 k 만큼 증가하는 부분이 왜 성능최적화에 사용된다는 말의 이유를 알고 싶다.